# 组件化

内容来自：

+ [Android组件化实战（一）](https://www.bilibili.com/video/BV1Ar4y1A7kh?from=search&seid=8189902028093625099)
+ [study_module](https://github.com/zouchanglin/study_module)



新建module，`File->New->New  Module`，选择`Android Library`

`settings.gradle`指定了大模块下有哪些子模块

创建玩新的module之后，主工程的`settings.gradle`会有相应的变更，如新建一个common模块后

```java
include ':common'
include ':app'
rootProject.name = "study_module"
```



common模块作为一个android库存在

```groovy
plugins {
    id 'com.android.library' // -> arr文件
}
```

> Android 库将编译为您可以用作 Android 应用模块依赖项的 **Android ARchive (AAR)** 文件
>
> - **AAR** 文件可以包含多项 Android 资源和一个清单文件，让您除了能够在 Java 类和方法中进行捆绑以外，还能够在布局和可绘制对象等共享资源中进行捆绑。
> - **AAR** 文件可以[包含 C/C++ 库](https://developer.android.com/studio/build/native-dependencies?hl=zh-cn)，供应用模块的 C/C++ 代码使用

注意显示的**图标**（在`settings.gradle`中导入后）

![011](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/011.png)



在`File->New->New  Module`，选择`Phone & Tablet Module`模块，可新建application模块

```groovy
plugins {
    id 'com.android.application' //->apk
}
```

可作为一个独立的app来运行，打包为`apk`



## Gradle执行顺序

可以在.gradle文件中加入打印输出语句，如

```groovy
println "study_module(root project) > settings.gradle"
```

1.如`study_module`模块下的`settings.gradle`，添加如下的打印：

```groovy
println "study_module(root project) > settings.gradle"
```

2.`study_module`模块下的`build.gradle`，添加如下的打印：

```groovy
println "study_module> build.gradle"
```

3.`app`模块下的`build.gradle`，添加如下的打印：

```java
println "app -> build.gradle"
```

4.`common`模块下的`build.gradle`，添加如下的打印：

```groovy
println "common> build.gradle"
```

执行顺序为：

```groovy
study_module(root project) > settings.gradle

> Configure project :
study_module> build.gradle

> Configure project :app
app -> build.gradle

> Configure project :common
common> build.gradle
```



先`settings.gradle`，再最外层的`build.gradle`，最后是module中的`build.gradle`



## 公共配置

![010](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/010.png)

可发现`common`模块下的`build.gradle`，与`app`模块下的`build.gradle`，内容大致相同，可以考虑抽取公共部分



在工程的最外层，定义一个`app_config.gradle`文件

选择，`File->New->File`->输入名称`app_config.gradle`

```java
ext {
    username="windzen"
}
```

然后在`rootProject`下的`build.gradle`，引入`app_config.gradle`

```groovy
apply from: 'app_config.gradle'
```

就可以使用定义的变量了，如使用`username`

```groovy
println "app_config.gradle username = " + rootProject.ext.username
```

```groovy
study_module(root project) > settings.gradle

> Configure project :
study_module> build.gradle
app_config.gradle username = windzen

> Configure project :app
app -> build.gradle

> Configure project :common
common> build.gradle
```

可以看到使用是没有问题的

修改下`app_config.gradle`中的内容，抽取公共的字段，如下：

```groovy
ext {
    username = "windzen"

    // Map定义
    app_android = [
        compileSdkVersion : 30,
        buildToolsVersion :  "30.0.2",
        minSdkVersion : 16
    ]
}
```

就可以在`app`、`order`、`common`、`personal`等模块下使用了（貌似是在在`rootProject`下的`build.gradle`，引入`app_config.gradle`后，其它模块貌似就不需要引入了）

![012](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/012.png)



### 不同的插件不同的效果

在`app_config.gradle`的`ext`中，定义一个`isRelease`

```groovy
ext {

    //是否是发布模式
    isRelease = true

    username = "windzen"

    // Map定义
    app_android = [
        compileSdkVersion : 30,
        buildToolsVersion :  "30.0.2",
        minSdkVersion : 16
    ]
}
```

如果是发布模式，也就是集成模式，就是把各个模块集成到一起。这种情况下，子模块就不能打成apk包了

修改`order`和`personal`模块下的`build.gradle`

![013](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/013.png)



另外，作为库的`order`和`personal`模块，如果还存在`applicationId`，在build的时候会有如下错误提示

![014](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/014.png)

所以进行如下的修改

![015](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/015.png)



最后，还需要在`app`模块中，将`order`和`personal`模块集成进去

修改app模块下的`build.gradle`

![016](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/016.png)

选择`Build`->`Build Bundle/APK`，反编译打出的包，可以发现如下的模块

![017](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/017.png)



## AndroidManifest的问题

如果子模块要单独调试，在`AndroidManifest`需要配置启动Actvity。而如果子模块作为被依赖的库，则不需要这些东西，所以，实现组件化，对`AndroidManifest`文件也要做相应的设置

如下，将子模块中`AndroidManifest`复制一份

`personal/src/main/debug/AndroidManifest.xml`文件内容

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.personal">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.Study_module">
        <activity android:name=".PersonalMainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
```

`personal/src/main/AndroidManifest.xml`文件内容

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.personal">

    <application>
        <activity android:name=".PersonalMainActivity" />
    </application>

</manifest>
```

在`personal`模块下的`build.gradle`中加入如下的内容：

```groovy
// 源集 —— 用来设置Java目录或者资源目录
sourceSets {
  main {
    if(!isRelease){
      // 如果是组件化模式，需要单独运行时
      manifest.srcFile 'src/main/debug/AndroidManifest.xml'
    }else {
      // 集成化模式，整个项目打包
      manifest.srcFile 'src/main/AndroidManifest.xml'
      java {
        // release 时 debug 目录下文件不需要合并到主工程
        //exclude '**/debug/**'
      }
    }
  }
}
```



## 子模块中的debug代码

在子模块中，可能要写一些debug代码，这些debug代码，在发布模式下也会被打进apk包中，这其实是不必要的

例如，如果在`order`模块下，有个dubug的`OrderDebugActivity`，在打包时：

![018](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/018.png)



可以使用`exclude`， `release` 时 `debug` 目录下文件不会被打包

```groovy
// 源集 —— 用来设置Java目录或者资源目录
sourceSets {
  main {
    if(!isRelease){
      // 如果是组件化模式，需要单独运行时
      manifest.srcFile 'src/main/debug/AndroidManifest.xml'
    }else {
      // 集成化模式，整个项目打包
      manifest.srcFile 'src/main/AndroidManifest.xml'
      java {
        // release 时 debug 目录下文件不需要合并到主工程
        exclude '**/debug/**'
      }
    }
  }
}
```































