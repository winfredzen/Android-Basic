# 组件化-路由

内容来自：

+ [Android组件化实战（三）](https://www.bilibili.com/video/BV1MK4y1m7cu)



## 公共依赖库的引入问题

可以在`app_config.gradle`中，定义好公共依赖库

```groovy
    // 定义依赖项目
    app_dependencies = [
            "okhttp": "com.squareup.okhttp3:okhttp:4.9.0",
            "constraintlayout": "androidx.constraintlayout:constraintlayout:2.0.4",
            "material": "com.google.android.material:material:1.3.0",
            "appcompat": "androidx.appcompat:appcompat:1.2.0",
            "junit": "junit:junit:4.+",
            "androidx_junit": "androidx.test.ext:junit:1.1.2",
            "espresso-core": "androidx.test.espresso:espresso-core:3.3.0"
            // ...
    ]
}
```

然后再在`common`模块的`build.gradle`中，引入

```groovy
    app_dependencies.each {k, v ->
        // api方式引入，其他模块在引入common时才会生效
        api v
        println('引入依赖: ' + k + " -> " + v)
    }
```



## 编译器传递参数

先在app模块下的 `build.gradle`中的`defaultConfig`中配置如下的内容：

![027](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/027.png)

然后在`annotation_processor`模块中，使用注解`@SupportedOptions`，传入key值

![028](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/028.png)

在`ARouterProcessor`的`init(ProcessingEnvironment processingEnv)`方法中获取编译器传递的参数

![029](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/029.png)

在`build`的时候，查看控制台输出

![030](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/030.png)



## BuildConfig的使用

可以在`defaultConfig`中配置`buildConfigField`

```groovy
        //这个方法接收三个非空的参数，第一个:确定值的类型；第二个:指定key的名字；第三个:传值(必须是String)
        //为什么需要定义这个？因为src代码中有可能需要用到跨模块交互，如果是组件化模块显然不行
        //切记:不能在android根节点，只能在defaultConfig或buildTypes节点下
        buildConfigField("boolean", "isRelease", String.valueOf(isRelease));
```

在自动生成的`BuildConfig.java`中则会有如下的内容

![031](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/031.png)

然后集可以在代码中使用了，如下，判断是否在发布模式下：

```java
if(BuildConfig.isRelease){
    Log.i(TAG, "onCreate: 集成化环境");
}else{
    Log.i(TAG, "onCreate: 组件化环境");
}
```



## 路由表

内容来自：

+ [Android组件化实战（四）](https://www.bilibili.com/video/BV1WK4y1m7Dy)

我们想要生成怎样的代码？

```java
例如：Personal Path：
// 这就是要用 APT 动态生成的代码
public class ARouter$$Path$$personal implements ARouterPath {

    @Override
    public Map<String, RouterBean> getPathMap() {
        Map<String, RouterBean> pathMap = new HashMap<>();

        pathMap.put("/personal/PersonalMainActivity",
                RouterBean.create(RouterBean.TypeEnum.ACTIVITY,
                                  Order_MainActivity.class,
                           "/personal/PersonalMainActivity",
                          "personal"));
        return pathMap;
    }
}

例如：Personal Group：
// 这就是要用 APT 动态生成的代码
public class ARouter$$Group$$personal implements ARouterGroup {

    @Override
    public Map<String, Class<? extends ARouterPath>> getGroupMap() {
        Map<String, Class<? extends ARouterPath>> groupMap = new HashMap<>();
        groupMap.put("personal", ARouter$$Path$$personal.class);
        return groupMap;
    }
}
```

如何实现呢？

**1.创建`router_api`模块**

在`router_api`模块定义2个接口：

+ `ARouterPath`
+ `ARouterGroup`



**2.在`common`模块下导入`router_api`模块**

```groovy
api project(':router_api')
```



**3.定义编译参数，`app`、`order`、`personal`模块都需要**

```groovy
//把包名传递进去
javaCompileOptions {
    annotationProcessorOptions{
        arguments = [moduleName: this.project.getName(), packageNameForAPT: packageNameForAPT]
    }
}
```

`packageNameForAPT`定义在`app_config.gradle`中，表示的是**APT生成java文件的包名**



**4.修改`annotation_processor`模块**

主要就是生成上面的类似的代码

例如，对`app`模块来说，`MainActivity`和`LoginActivity`都使用了`@ARouter`注解

![032](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/032.png)

![033](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/033.png)

最终生成的类如下：

![034](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/034.png)

![035](https://github.com/winfredzen/Android-Basic/blob/master/%E6%9E%B6%E6%9E%84/images/035.png)





























