
# 事件分发深入二

本文内容来自《Android自定义控件高级进阶与精彩实例》

主要是研究`ACTION_MOVE`消息的流向

## dispatchTouchEvent函数中返回true时`ACTION_MOVE`的消息流向

**1.TextView的dispatchTouchEvent函数中返回true**

控制台的输出结果如下：

```java
2021-10-19 09:50:09.657 14839-14839/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:09.658 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:09.658 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:09.658 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:09.659 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:09.659 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomTextView dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 09:50:10.224 14839-14839/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 09:50:10.224 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 09:50:10.224 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION_MOVE
2021-10-19 09:50:10.225 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 09:50:10.225 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION_MOVE
2021-10-19 09:50:10.225 14839-14839/com.touch.harvic.testtouchevent D/qijian: CustomTextView dispatchTouchEvent  EVENT: ACTION_MOVE
```

图形表示如下（红色表示`ACTION_DOWN`，蓝色表示`ACTION_MOVE`）：

![124](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/124.jpeg)



**2.在ViewGroup2的dispatchTouchEvent函数中返回true**

![125](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/125.jpeg)



**3.在ViewGroup1的dispatchTouchEvent函数中返回true**

![126](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/126.jpeg)



**4.在Activity的dispatchTouchEvent函数中返回true**

![127](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/127.jpeg)



## 传递到onTouchEvent函数后的`ACTION_MOVE`的消息

**1.正常情况下的ACTION_MOVE消息传递过程**

即在所有的函数中都不拦截消息的情况下

控制的输出结果如下，可以看出`ACTION_MOVE`和`ACTION_DOWN`的区别

```java
2021-10-19 10:27:28.290 15126-15126/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.290 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.290 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomTextView dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomTextView onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onTouchEvent   EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.291 15126-15126/com.touch.harvic.testtouchevent D/qijian: SecondActivity onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:27:28.324 15126-15126/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:27:28.324 15126-15126/com.touch.harvic.testtouchevent D/qijian: SecondActivity onTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:27:28.408 15126-15126/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
```

![128](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/128.jpeg)



**2.当在onTouchEvent函数中拦截ACTION_DOWN消息**

当ViewGroup2的`onTouchEvent`函数返回`true`时

```java
2021-10-19 10:36:11.576 15303-15336/com.touch.harvic.testtouchevent D/EGL_emulation: eglMakeCurrent: 0xe081a240: ver 3 0 (tinfo 0xe080f250)
2021-10-19 10:36:14.685 15303-15303/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.685 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomTextView dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomTextView onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:36:14.686 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onTouchEvent   EVENT: ACTION DOWN
2021-10-19 10:36:14.806 15303-15303/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:36:14.806 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:36:14.806 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:36:14.806 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:36:14.806 15303-15303/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onTouchEvent   EVENT: ACTION_MOVE
```

![129](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/129.jpeg)

当TextView的`dispatchTouchEvent`函数返回false时，且ViewGroup1的`onTouchEvent`返回true拦截消息时

```java
2021-10-19 10:43:36.579 15469-15469/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomTextView dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onTouchEvent   EVENT: ACTION DOWN
2021-10-19 10:43:36.580 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:43:36.807 15469-15469/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:43:36.807 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:43:36.807 15469-15469/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onTouchEvent  EVENT: ACTION_MOVE
```

![130](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/130.jpeg)



同样如果我们在ViewGroup2的`onInterceptTouchEvent`中拦截消息，并在ViewGroup1的`onTouchEvent`函数中消费消息

```java
2021-10-19 10:47:37.043 15623-15654/com.touch.harvic.testtouchevent D/EGL_emulation: eglMakeCurrent: 0xf3b7fac0: ver 3 0 (tinfo 0xe885b920)
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup dispatchTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onInterceptTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomSecondGroup onTouchEvent   EVENT: ACTION DOWN
2021-10-19 10:47:40.699 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onTouchEvent  EVENT: ACTION DOWN
2021-10-19 10:47:40.956 15623-15623/com.touch.harvic.testtouchevent D/qijian: SecondActivity dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:47:40.956 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup dispatchTouchEvent  EVENT: ACTION_MOVE
2021-10-19 10:47:40.956 15623-15623/com.touch.harvic.testtouchevent D/qijian: CustomFirstGroup onTouchEvent  EVENT: ACTION_MOVE
```

![131](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/131.jpeg)



## 在ACTION_MOVE消息到来时拦截

前面讲的都是在`ACTION_DOWN`消息到来时进行拦截，但如果要拦截`ACTION_MOVE`消息该怎么处理呢？

正常情况下的消息传递流程

![132](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/132.jpeg)

如果我们在ViewGroup1的`onInterceptTouchEvent`函数中将代码改为如下形似：

```java
    @Override
    public boolean onInterceptTouchEvent(MotionEvent event) {
        LogHelper.onLog("CustomFirstGroup onInterceptTouchEvent",event);
        switch (event.getAction()) {
            case ACTION_MOVE:
                return true;
        }
        return super.onInterceptTouchEvent(event);
    }
```

> 即如果消息类型是`ACTION_MOVE`时，返回true，来拦截，对其它的消息默认处理

此时的消息流程

![133](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/133.png)

使用图形表示如下（绿色表示第一个的`ACTION_MOVE`， 蓝色表示后续的`ACTION_MOVE`）：

![134](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/134.jpeg)

> 第一次的`ACTION_MOVE`，被ViewGroup1的`onInterceptTouchEvent`函数拦截后。到这里后，`ACTION_MOVE`消息就没有了，变成了`ACTION_CANCEL`

同样的，如果在ViewGroup1的`onTouchEvent`返回`true`，它的消息传递流程，如下图所示：

![135](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/135.jpeg)



### 其它方式

**1.在ViewGroup2的`dispatchTouchEvent`函数中返回`true`拦截`ACTION_MOVE`消息**

```java
    public boolean dispatchTouchEvent(MotionEvent event) {
        LogHelper.onLog("CustomSecondGroup dispatchTouchEvent",event);
        switch (event.getAction()){
        case ACTION_MOVE:
            return true;
        }
        return super.dispatchTouchEvent(event);
    }
```

![136](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/136.png)

![137](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/137.jpeg)

> 这里没有发出`ACTION_CANCEL`消息，而是消息被截断了，而且也不会向`onTouchEvent`传递



**2.在ViewGroup2的`dispatchTouchEvent`函数中返回`false`拦截`ACTION_MOVE`消息**

```java
public boolean dispatchTouchEvent(MotionEvent event) {
        LogHelper.onLog("CustomSecondGroup dispatchTouchEvent",event);
        switch (event.getAction()){
        case ACTION_MOVE:
            return false;
        }
        return super.dispatchTouchEvent(event);
    }
```

![138](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/138.png)

![139](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/139.jpeg)

> 消息在传递到ViewGroup2后，直接流到Activity的`onTouchEvent`函数中，很特别的情况

测试后，会发现，无论在哪个控件的`dispatchTouchEvent`函数中返回false，之后的消息都会直接到Activity的`onTouchEvent`函数中

![140](https://github.com/winfredzen/Android-Basic/blob/master/自定义视图/images/140.png)









