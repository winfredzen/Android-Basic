# AOP

AOP可以无侵入式的埋点，方便统计程序时间

本来是参考：[HujiangTechnology](https://github.com/HujiangTechnology)/**[gradle_plugin_android_aspectjx](https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx)**

但是这个开源项目已经很久没有维护了，在用的过程中遇到很多的问题，如：

1.提示`java.lang.ClassNotFoundException`

2.提示`java.util.zip.ZipException: zip file is empty`

各种异常，但是在[原作者已不再维护，继续使用建议使用我fork后修复发布的版本。（给即将使用或已经使用的几点建议）](https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx/issues/332)中，其他作者给出了解决办法

所以使用：[wurensen](https://github.com/wurensen)/**[gradle_plugin_android_aspectjx](https://github.com/wurensen/gradle_plugin_android_aspectjx)**

我自己尝试了，可以解决大部分问题，使用方式与原来的基本类似

使用步骤：

1.项目的`build.gradle`中添加

```groovy
// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    repositories {
        // 已发布到mavenCentral仓库
        mavenCentral()
    }

    dependencies {
        // aspectj插件
        classpath 'io.github.wurensen:gradle-android-plugin-aspectjx:<version>'
    }
}
```

2.app模块下的`build.gradle`

```shell
// 3.0.0开始，id已变更：
apply plugin: 'io.github.wurensen.android-aspectjx'

// 3.0.0以下：
apply plugin: 'android-aspectjx'
//或者这样也可以
apply plugin: 'com.hujiang.android-aspectjx'
```

3.可能需要添加一些`exclude`，如：

```groovy
aspectjx {
    // 移除kotlin相关，编译错误和提升速度
    exclude 'kotlin.jvm', 'kotlin.internal'
    exclude 'kotlinx.coroutines.internal', 'kotlinx.coroutines.android'
}
```



## aspectj

![016](https://github.com/winfredzen/Android-Basic/blob/master/%E4%BC%98%E5%8C%96/images/016.png)



### 语法介绍

参考：

+ [Android进阶宝典 -- AOP (AspectJ入门)](https://juejin.cn/post/7095296650352001054)

+ [Android切面编程AOP之AspectJ的使用](https://blog.csdn.net/wbwjx/article/details/121881427)
+ [AspectJ在Android 中的使用攻略](https://juejin.cn/post/6977152381343498270#heading-3)



监控Application的`onCreate`方法中调用方法的耗时：

```java
/**
 * AOP.
 */
@Aspect
public class PerformanceAop {

    private static final String TAG = "PerformanceAop";

    /**
     * 切入点.
     *
     * @param joinPoint joinPoint
     */
    @Around("call(void com.xxx.xxxx.app.CarApplication.*(..))")
    public void getTime(ProceedingJoinPoint joinPoint) {
        //LogUtils.e(TAG, "getTime");
        Signature signature = joinPoint.getSignature();
        String name = signature.toShortString();
        long time = System.currentTimeMillis();
        try {
            joinPoint.proceed();
        } catch (Throwable throwable) {
            throwable.printStackTrace();
        }
        LogUtils.e(TAG, name + " cost " + (System.currentTimeMillis() - time));
    }


```













