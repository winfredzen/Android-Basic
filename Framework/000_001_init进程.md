# initè¿›ç¨‹

å‚è€ƒï¼š

+ [Android å¼€å‘ä¹‹â€”â€”zygoteè¿›ç¨‹åŸç†è¯¦è§£ï¼Œå½»åº•ç†è§£zygoteæœºåˆ¶ä¸å†…æ ¸è®¾è®¡](https://www.bilibili.com/video/BV1Z5411H7Gq?p=1&vd_source=308fc9b57cdc925a463da02262234ff6)



`ps`å‘½ä»¤å‚è€ƒï¼š

+ [Linux pså‘½ä»¤è¯¦è§£ï¼šæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹](http://c.biancheng.net/view/1062.html)
+ [10ä¸ªé‡è¦çš„Linux pså‘½ä»¤å®æˆ˜](https://linux.cn/article-4743-1.html)



`kill`å‘½ä»¤å‚è€ƒï¼š

+ [Linux killå‘½ä»¤è¯¦è§£ï¼šç»ˆæ­¢è¿›ç¨‹](http://c.biancheng.net/view/1068.html)



`init`è¿›ç¨‹æ—¶Androidæ‰‹æœºå¯åŠ¨çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹

+ å®ˆæŠ¤ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡
+ å¯åŠ¨éœ€è¦çš„æœåŠ¡

![004](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/004.png)



å‚è€ƒã€ŠAndroidè¿›é˜¶è§£å¯†ã€‹

> initç”±å¤šä¸ªæºæ–‡ä»¶å…±åŒç»„æˆï¼Œè¿™äº›æºæ–‡ä»¶ä½äº`system/core/init`
>
> initè¿›ç¨‹å¯åŠ¨åšäº†å¾ˆå¤šå·¥ä½œï¼Œæ€»çš„æ¥è¯´åšäº†ä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š
>
> + åˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€çš„æ–‡ä»¶ç›®å½•
> + åˆå§‹åŒ–å’Œå¯åŠ¨å±æ€§æœåŠ¡
> + è§£æ`init.rc`é…ç½®æ–‡ä»¶å¹¶å¯åŠ¨Zygoteè¿›ç¨‹



`adb shell`è¿›å…¥shellåï¼Œè¾“å…¥`ps -A` åˆ—å‡ºæ‰€æœ‰çš„è¿›ç¨‹

åœ¨æœ¬äºº`Google Pixel Android 10`çš„ç³»ç»Ÿçš„æ‰‹æœºä¸Šï¼Œæ˜¾ç¤ºçš„å†…å®¹å¦‚ä¸‹ï¼š

![002](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/002.png)

å¯è§ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯`init`è¿›ç¨‹

> `USER           PID  PPID     VSZ    RSS WCHAN            ADDR S NAME` å«ä¹‰è¯´æ˜

> `USER `- è¯¥ process å±äºé‚£ä¸ªä½¿ç”¨è€…è´¦å·çš„
>
> `PID`  - è¯¥ process çš„å·ç 
>
> `PPID`  - å…¶ä¸Šçº§çˆ¶ç¨‹åºçš„ID



ä»ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ä¸º`init`è¿›ç¨‹

![003](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/003.png)



å¦‚æœè¯•å›¾å¼ºåˆ¶ç»“æŸæŸä¸ªçˆ¶è¿›ç¨‹ä¸º`init`çš„è¿›ç¨‹ï¼Œä¼šæ˜¯ä»€ä¹ˆæ•ˆæœï¼Ÿ

> å¦‚ç»“æŸæ‰`netd`è¿›ç¨‹?
>
> 1.æŸ¥æ‰¾`netd`è¿›ç¨‹ï¼Œ`ps -ef | grep netd | grep -v grep`ï¼Œæ˜¾ç¤ºå‡ºæ‰€æœ‰çš„`netd`è¿›ç¨‹ï¼Œå»å¤„æ‰å½“å‰çš„`grep`è¿›ç¨‹ã€‚
>
> ```java
> root           626     1 0 23:45:40 ?     00:00:01 netd
> ```
>
> 2.è·å–åˆ°`pid`ä¸º626ï¼Œç»“æŸåˆ°æ­¤è¿›ç¨‹`kill -9 626`
>
> ```shell
> kill -9 626
> ```
>
> 3.å†é€šè¿‡`ps -ef | grep netd | grep -v grep`ï¼ŒæŸ¥æ‰¾`netd`è¿›ç¨‹ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š
>
> ```sh
> root          7718     1 1 00:26:34 ?     00:00:00 netd
> ```
>
> å¯ä»¥å‘ç°ï¼Œ`netd`è¿›ç¨‹åˆè¢«é‡å¯äº†ï¼Œå¹¶æ²¡æœ‰è¢«killæ‰



## init.rc

æ‰‹æœºå‚å•†å®ç°è‡ªåŠ¨å¯åŠ¨æœåŠ¡ï¼Ÿ`init.rc`

![005](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/005.png)

å¦‚åœ¨`init.zygote32.rc`ä¸­çš„å†…å®¹

![006](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/006.png)

```java
service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    class main
    priority -20
    user root
    group root readproc reserved_disk
    socket zygote stream 660 root system
    socket usap_pool_primary stream 660 root system
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart audioserver
    onrestart restart cameraserver
    onrestart restart media
    onrestart restart netd
    onrestart restart wificond
    writepid /dev/cpuset/foreground/tasks
```

> service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
>
> æ‰§è¡Œserviceå‘½ä»¤ï¼Œå¯åŠ¨zygoteï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä½äº`/system/bin/app_process`

![007](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/007.png)



`app_process`æ˜¯`app_main.cpp`ç¼–è¯‘è€Œæ¥çš„ï¼Œåœ¨å…¶`main`å‡½æ•°ä¸­

![016](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/016.png)

![017](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/017.png)

> `runtime.start("com.android.internal.os.ZygoteInit", args, zygote);`
>
> å¯åŠ¨`ZygoteInit`



**ZygoteInit**

`ZygoteInit`ä¸­æœ‰ä¸ª`ZygoteServer`

![018](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/018.png)



`ZygoteServer`ä¸­æœ‰ä¸ª[LocalServerSocket](https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/net/LocalServerSocket.java;drc=2dbfe014f76bc8789af9f74ef42e908e0fcc39e6;l=27) å˜é‡

![019](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/019.png)

*soï¼Œä¸ºä»€ä¹ˆä½¿ç”¨socketæ¥é€šä¿¡ï¼Ÿ*

> binderè™½ç„¶æ€§èƒ½æ¯”è¾ƒé«˜ï¼Œä½†å®¹æ˜“è¢«hookï¼Œæœ‰å®‰å…¨æ€§æ–¹é¢çš„é—®é¢˜



`ZygoteInit`é¢„åŠ è½½ç±»ï¼Œ`preload`->`preloadClasses`

![020](https://github.com/winfredzen/Android-Basic/blob/master/Framework/images/020.png)

> è·¯å¾„ä¸º`/system/etc/preloaded-classes`
>
> åŒ…æ‹¬`android.app.Activity`ã€`android.app.ActivityManager`ç­‰



## å…¶å®ƒ

####  ä¸ºä»€ä¹ˆä½¿ç”¨socketï¼Ÿ

å‚è€ƒï¼š

+ [androidä¸­AMSé€šçŸ¥Zygoteå»forkè¿›ç¨‹ä¸ºä»€ä¹ˆä½¿ç”¨socketè€Œä¸ä½¿ç”¨binderï¼Ÿ](https://blog.csdn.net/rzleilei/article/details/125770598)
+ [ä¸ºä»€ä¹ˆsystemServerè¿›ç¨‹ä¸zygoteè¿›ç¨‹çš„é€šä¿¡æ˜¯ä½¿ç”¨socketè€Œä¸æ˜¯binderï¼Ÿ](https://blog.csdn.net/augfun/article/details/110790337)
+ [Android Framework ç¬”è®°](https://juejin.cn/post/7028895615304073223)

è¯´æ³•å¾ˆå¤šï¼Œè¿˜å¯å‚è€ƒï¼š

+ [COWå¥¶ç‰›ï¼Copy On Writeæœºåˆ¶äº†è§£ä¸€ä¸‹](https://juejin.cn/post/6844903702373859335)
+ [ğŸ“”ã€æ“ä½œç³»ç»Ÿã€‘å†™æ—¶å¤åˆ¶ Copy-on-write](https://imageslr.com/2020/copy-on-write.html)





