# 屏幕方向监听

[OrientationEventListener](https://developer.android.com/reference/android/view/OrientationEventListener#onOrientationChanged(int))可用来监听设备的方向

> Helper class for receiving notifications from the `SensorManager` when the orientation of the device has changed.
>
> 当设备的方向发生变化时，用于从 `SensorManager` 接收通知的帮助类

```kotlin
public abstract void onOrientationChanged (int orientation)
```

> 当设备的方向改变时调用。 方向参数以度为单位，取值范围为 0 到 359。方向为0度，当设备处于自然位置时，90度，左侧在顶部，180度，倒置，270度 右侧是顶部。 当设备接近平坦且无法确定方向时，返回 `ORIENTATION_UNKNOWN`。

开始监听和结束监听

```kotlin
public void enable ()
public void disable ()
```

在[Camera preview](https://developer.android.com/training/camera2/camera-preview)一节中，也有如下的说明：

> [`OrientationEventListener#onOrientationChanged()`](https://developer.android.com/reference/android/view/OrientationEventListener#onOrientationChanged(int)) returns the clockwise rotation of the device (from the user’s point of view). Negate the value for use in the formula above.

我自己测试了下

1.竖直方向，即正常方向时，orientation大概为0

2.顺时针旋转，orientation开始增大



可以将`OrientationEventListener`封装在LiveData中，可参考：

+ [OrientationLiveData](https://github.com/winfredzen/Android-Basic/blob/master/Camera/code/Camera2Basic/utils/src/main/java/com/example/android/camera/utils/OrientationLiveData.kt)

+ [扩展 LiveData](https://developer.android.com/topic/libraries/architecture/livedata#extend_livedata)



```kotlin
/**
 * Calculates closest 90-degree orientation to compensate for the device
 * rotation relative to sensor orientation, i.e., allows user to see camera
 * frames with the expected orientation.
 */
class OrientationLiveData(
        context: Context,
        characteristics: CameraCharacteristics
): LiveData<Int>() {

    private val listener = object : OrientationEventListener(context.applicationContext) {
        override fun onOrientationChanged(orientation: Int) {
            Log.d("OrientationLiveData", "orientation = $orientation")
            val rotation = when {
                orientation <= 45 -> Surface.ROTATION_0
                orientation <= 135 -> Surface.ROTATION_90
                orientation <= 225 -> Surface.ROTATION_180
                orientation <= 315 -> Surface.ROTATION_270
                else -> Surface.ROTATION_0
            }
            val relative = computeRelativeRotation(characteristics, rotation)
            if (relative != value) postValue(relative)
        }
    }

    override fun onActive() {
        super.onActive()
        listener.enable()
    }

    override fun onInactive() {
        super.onInactive()
        listener.disable()
    }

    companion object {

        /**
         * Computes rotation required to transform from the camera sensor orientation to the
         * device's current orientation in degrees.
         *
         * @param characteristics the [CameraCharacteristics] to query for the sensor orientation.
         * @param surfaceRotation the current device orientation as a Surface constant
         * @return the relative rotation from the camera sensor to the current device orientation.
         */
        @JvmStatic
        private fun computeRelativeRotation(
                characteristics: CameraCharacteristics,
                surfaceRotation: Int
        ): Int {
            val sensorOrientationDegrees =
                    characteristics.get(CameraCharacteristics.SENSOR_ORIENTATION)!!

            val deviceOrientationDegrees = when (surfaceRotation) {
                Surface.ROTATION_0 -> 0
                Surface.ROTATION_90 -> 90
                Surface.ROTATION_180 -> 180
                Surface.ROTATION_270 -> 270
                else -> 0
            }

            // Reverse device orientation for front-facing cameras
            val sign = if (characteristics.get(CameraCharacteristics.LENS_FACING) ==
                    CameraCharacteristics.LENS_FACING_FRONT) 1 else -1

            // Calculate desired JPEG orientation relative to camera orientation to make
            // the image upright relative to the device orientation
            return (sensorOrientationDegrees - (deviceOrientationDegrees * sign) + 360) % 360
        }
    }
}
```



























