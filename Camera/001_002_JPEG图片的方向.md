# JPEG图片的方向

在上一节的Camera2 API的使用一文中，我自己实践后，发现图片的方向有点问题，所以记录下来自己验证的过程

在上面的教程中，拍照take photo，如果输出`.jpg`文件，教程中通过如下的方式设置方向：

```java
int rotation = getWindowManager().getDefaultDisplay().getRotation();
Log.e(TAG, "rotation = " + rotation + "ORIENTATIONS.get(rotation) = " + ORIENTATIONS.get(rotation));
captureStillBuilder.set(CaptureRequest.JPEG_ORIENTATION, ORIENTATIONS.get(rotation));
```

```kotlin
private static final SparseIntArray ORIENTATIONS = new SparseIntArray();
static {
    ORIENTATIONS.append(Surface.ROTATION_0, 90);
    ORIENTATIONS.append(Surface.ROTATION_90, 0);
    ORIENTATIONS.append(Surface.ROTATION_180, 270);
    ORIENTATIONS.append(Surface.ROTATION_270, 180);
}
```

然而，不同的手机，对这个方向的处理，貌似有不同

**Google Pixel**

手机正常的竖直方向，后置摄像头，拍摄一个正常的*笑脸*

1.如果不设置`CaptureRequest.JPEG_ORIENTATION`

但是在Android Studio中显示和Android的`ImageView`中显示，都是逆时针旋转90度，效果如下：

![013](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/013.png)

导出图像到Mac电脑，使用其它软件，查看exif元数据

![014](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/014.png)

> 没有图像方向信息

使用Mac上的*预览*来查看图片，同样是逆时针旋转90度

![015](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/015.png)

2.如果设置`CaptureRequest.JPEG_ORIENTATION`

```java
captureStillBuilder.set(CaptureRequest.JPEG_ORIENTATION, ORIENTATIONS.get(rotation));
```

Android Studio中显示和Android的`ImageView`中显示，都是正常的

![016](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/016.png)

查看exif元数据

![017](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/017.png)

> 没有图像方向信息

使用Mac上的*预览*来查看图片，方向是正常的

![018](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/018.png)



**小米手机**

1.如同上面的第二步，设置`CaptureRequest.JPEG_ORIENTATION`

但结果却是，Android Studio中显示和Android的`ImageView`中显示，都是逆时针旋转90度

![019](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/019.png)

查看exif元数据

![020](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/020.png)

但是使用Mac上的*预览*来查看图片，方向是正常的，也显示了图片的方向位**6**(6的含义，见下文)

![021](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/021.png)



2.如果不设置`CaptureRequest.JPEG_ORIENTATION`

Android Studio中显示和Android的`ImageView`中显示，都是逆时针旋转90度

Mac上显示的也是逆时针旋转90度

查看exif元数据

![024](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/024.png)







**为什么在不同的手机上，有不同的显示效果呢？**

在网络上有如下的文章：

+ [Android相机拍照方向旋转的解决方案：ExifInterface](https://www.jianshu.com/p/95cd95e961d7)
+ [Camera2拍照时图片角度旋转处理](https://www.jianshu.com/p/dc31c25c3d48)

> ```java
> captureBuilder.set(CaptureRequest.JPEG_ORIENTATION, mSensorOrientation);
> ```
>
> ##### 但是，这个方法是否可用，是依赖于底层的，也就是说，底层没有做相应的处理的话，设置之后才有效果，如果底层没有做相应的处理，是没有作用。（如三星手机是没有做相应的处理的）



## EXIF

> **可交换图像文件格式**（英語：Exchangeable image file format，官方簡稱**Exif**），是专门为[数码相机](https://zh.m.wikipedia.org/wiki/数码相机)的照片设定的[檔案格式](https://zh.m.wikipedia.org/wiki/檔案格式)，可以记录数码照片的属性信息和拍摄数据。
>
> Exif可以附加于[JPEG](https://zh.m.wikipedia.org/wiki/JPEG)、[TIFF](https://zh.m.wikipedia.org/wiki/TIFF)、[RIFF](https://zh.m.wikipedia.org/wiki/RIFF)等文件之中，为其增加有关数码相机拍摄信息的内容和索引图或图像处理软件的版本信息。
>
> Exif信息是可以被任意编辑的，因此只有参考的功能。
>
> Exif信息以`0xFFE1`作为开头标记，后两个字节表示Exif信息的长度。所以Exif信息最大为64 kB，而**内部采用TIFF格式**。



推荐文章：

+ [JPEG Image Orientation and Exif](https://jdhao.github.io/2019/07/31/image_rotation_exif_info/)

> ![022](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/022.png)
>
> ![023](https://github.com/winfredzen/Android-Basic/blob/master/Camera/images/023.png)



**Picasso处理**

参考：

+ [Android: Handling JPEG images with Exif orientation flags](https://ashishb.net/tech/android-handling-jpeg-images-with-exif-orientation-flags/)

> Here is a piece of code from Picasso which loads a JPEG as an in-memory bitmap and performs the right translation/rotation.
>
> ```java
> // Get the orientation
> ExifInterface exifInterface = new ExifInterface(imageFilePath);
> int exifOrientation = exifInterface.getAttributeInt(TAG_ORIENTATION, ORIENTATION_NORMAL)
> 
> // Take the source of these methods from 
> // https://github.com/square/picasso/blob/31779ac2cb971c4534cc17bd437fab1aa0083d3d/picasso/src/main/java/com/squareup/picasso3/BitmapHunter.java#L625-L659
> int exifRotation = getExifRotation(exifOrientation);
> int exifTranslation = getExifTranslation(exifOrientation);
> 
> Matrix matrix = new Matrix();
> if (exifRotation != 0) {
>   matrix.preRotate(exifRotation);
> }
> if (exifTranslation != 1) {
>   matrix.postScale(exifTranslation, 1);
> }
> 
> ```





## CaptureRequest.JPEG_ORIENTATION

如何设置[CaptureRequest.JPEG_ORIENTATION](https://developer.android.com/reference/android/hardware/camera2/CaptureRequest#JPEG_ORIENTATION)

```java
private int getJpegOrientation(CameraCharacteristics c, int deviceOrientation) {
     if (deviceOrientation == android.view.OrientationEventListener.ORIENTATION_UNKNOWN) return 0;
     int sensorOrientation = c.get(CameraCharacteristics.SENSOR_ORIENTATION);

     // Round device orientation to a multiple of 90
     deviceOrientation = (deviceOrientation + 45) / 90 * 90;

     // Reverse device orientation for front-facing cameras
     boolean facingFront = c.get(CameraCharacteristics.LENS_FACING) == CameraCharacteristics.LENS_FACING_FRONT;
     if (facingFront) deviceOrientation = -deviceOrientation;

     // Calculate desired JPEG orientation relative to camera orientation to make
     // the image upright relative to the device orientation
     int jpegOrientation = (sensorOrientation + deviceOrientation + 360) % 360;

     return jpegOrientation;
 }
 
```

> 这里要考虑：
>
> + 设备方向
> + 传感器方向
> + 前置摄像头、后置摄像头







## 其它

mac上可使用`MetaImage`来查看exif信息，自带的`preview`预览程序也支持































