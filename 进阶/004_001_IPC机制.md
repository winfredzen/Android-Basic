# IPC机制

内容来自《Android开发艺术探索》



## 多进程模式

**为什么要采用多进程？**

+ 应用因为某些原因自身需要采用多进程模式
+ 当前应用需要向其它应用获取数据

**怎么开启多进程？**

给四大组件在`AndroidManifest.xml`中指定`android:process`

另一种非常规方式，通过JNI在`native`层去`fork`一个新的进程

如下，配置了3个Activity：

```xml
        <activity
            android:name=".ThirdActivity"
            android:exported="false"
            android:process="com.wz.ipcdemo.remote"
            />
        <activity
            android:name=".SecondActivity"
            android:exported="false"
            android:process=":remote"
            />
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
```

启动3个Activity后，会发现存在3个进程：

![145](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/145.png)

或者通过`adb shell ps -ef | grep com.wz`

![146](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/146.png)

> `:`表示在当前的进程名前附加上当前的包名，以`:`开头的进程属于当前应用的私有进程，其它应用的组件不可以和它跑在同一个进程中
>
> 进程名不以`:`开头的进程属于全局进程，其它应用通过`ShareUID`方式可以和它跑在同一个进程中

![147](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/147.png)



### 问题

多进程会造成如下方面的问题：

**1.静态成员和单例模式完全无效**

如在MainActivity中设置`UserManager.sUserId = 2;`

在SecondActivity中获取`UserManager.sUserId`，分别打印，结果却并不一致

```java
2021-11-11 00:58:27.930 7427-7427/com.wz.ipcdemo D/MainActivity: onCreate UserManager.sUserId = 2

2021-11-11 00:58:33.781 9786-9786/com.wz.ipcdemo D/SecondActivity: onCreate UserManager.sUserId = 1
```

> 原因：Android为每一个应用分配了一个虚拟机，或者说为每一个进程分配了一个独立的虚拟机。不同的虚拟机在内存分配上有不同的地址空间，这就导致在不同的虚拟机中访问同一个类的对象会产生多个副本



**2.线程同步机制完全失效**



**3.`SharedPreferences`的可靠性下降**

`SharedPreferences`不支持两个进程同时去执行写操作



**4.`Application`会多次创建**

当一个组件跑在一个新的进程时，由于系统要在创建新的进程并分配独立的虚拟机，所以这个过程就是启动一个应用的过程



```java
2021-11-11 01:17:12.042 9966-9966/com.wz.ipcdemo D/MyApplication: application start, process name:com.wz.ipcdemo
2021-11-11 01:17:47.286 10010-10010/com.wz.ipcdemo D/MyApplication: application start, process name:com.wz.ipcdemo:remote
2021-11-11 01:18:00.803 10050-10050/com.wz.ipcdemo.remote D/MyApplication: application start, process name:com.wz.ipcdemo.remote
```























