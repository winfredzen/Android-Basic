# APT

APT Annotation Processing Tool 注解处理器

Java注解（Annotation），又可称为Java标注。它是一种**注释机制**，用于对类、方法、变量、参数和包等进行标注

> 注解，是**给编译器看的**。编译器可以在编译过程中，将注解里面的信息收集起来，在编译过程中处理，或者是嵌入到最终字节码中，Java虚拟机在加载类的同时会加载这些注解的内容，供程序在运行时获取。
>
> 按照注解的生命周期（使用 `@Retention` 指定）不同，注解主要可以分为下面几种：
>
> - ***SOURCE：*** 只会保留在源码里，源码经过编译后，注解信息会被丢弃，不会保留在编译好的class文件里；
> - ***CLASS：*** 注解在class文件中可用，但会被JVM丢弃。该类型的注解信息会保留在源码里和class文件里，在执行的时候，不会加载到虚拟机中。这也是默认的生命周期；
> - ***RUNTIME：*** 注解信息将在运行期（Java虚拟机加载之后）也保留，因此可以通过反射机制读取注解的信息。



**工作原理**

注解只是信息、标注，需要对信息进行处理，才能发挥其作用，因此牵涉出了注解处理这个过程。编译器可以帮助我们收集注解，但是处理逻辑还是需要开发者自行指定。

![067](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/067.jpeg)

+ **注解工程：** 用于声明自定义注解
+ **注解处理器工程：** 依赖注解工程，实现注解处理器，并通过META-INF中的配置，指定对应的实现类，供Java编译器查找。

+ **Android工程：** 即我们的日常工程，需要依赖上述两者。在使用注解后，还要在第三方依赖中声明上述注解处理器，告知Java编译器需帮助我们收集注解并回调给该注解处理器。



**开发流程**

![068](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/068.png)

![069](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/069.png)



## 建立注解

### 定义注解

建立注解工程

1.File->New->Directory，命名为`router-annotations`

2.在`router-annotations`中新建`build.gradle`

```groovy
// 应用java插件
apply plugin: 'java'

// 设置源码兼容性
targetCompatibility = JavaVersion.VERSION_1_7
sourceCompatibility = JavaVersion.VERSION_1_7
```

3.`settings.gradle`中引入

```groovy
include ':router-annotations'
```

4.在`router-annotations`新建源码目录

![070](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/070.png)

5.定义注解`Destination`

```java
/**
 * 说明当前注解可以修饰的元素，此处表示可以用于标记在类上面
 */
@Target({ElementType.TYPE})
/**
 * 说明当前注解可以被保留的时间
 */
@Retention(RetentionPolicy.CLASS)
public @interface Destination {

    /**
     * 当前页面的URL，不能为空
     * @return 页面URL
     */
    String url();

    /**
     * 对于当前页面的中文描述
     * @return 例如 "个人主页"
     */
    String description();
}
```

6.app依赖`router-annotations`

```groovy
implementation project(':router-annotations')
```



### 使用注解

```java
@Destination(
        url = "router://page-home",
        description = "应用主页"
)
public class MainActivity extends Activity
```



## 注解处理器

### 建立注解处理器工程

1.新建`router-processor`模块，步骤与上面类似

2.新建`build.gradle`文件

```groovy
// 引入java插件，帮助编译代码
apply plugin: 'java'

dependencies {
    implementation project(':router-annotations')
    implementation 'com.google.auto.service:auto-service:1.0-rc6'
    annotationProcessor 'com.google.auto.service:auto-service:1.0-rc6'
    implementation 'com.google.code.gson:gson:2.8.1'
}
```

3.src，包结构

![071](https://github.com/winfredzen/Android-Basic/blob/master/%E8%BF%9B%E9%98%B6/image/071.png)

4.新建`DestinationProcessor`类，继承自`AbstractProcessor`

实现方法

1.`getSupportedAnnotationTypes`

```java
    /**
     * 告诉编译器，当前处理器支持的注解类型
     * @return
     */
    @Override
    public Set<String> getSupportedAnnotationTypes() {
        return Collections.singleton(
                Destination.class.getCanonicalName()
        );
    }
```

2.`process`

```java
    /**
     * 编译器找到我们关心的注解后，会回调这个方法
     * @param set
     * @param roundEnvironment
     * @return
     */
    @Override
    public boolean process(Set<? extends TypeElement> set,
                           RoundEnvironment roundEnvironment) {
```



## 采集注解















































